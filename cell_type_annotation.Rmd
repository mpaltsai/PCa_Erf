---
title: "cell population annotation without organoids Song 2022"
author: "Ismini"
date: "2025-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(SeuratObject)
library(dplyr)
library(ggplot2)
library(patchwork)
```

```{r, read-and-merge-samples}
#read the list with samples
obj_to_integrate <- readRDS("../list_filtered_seurat_Song_2022.rds")
no_organoids <- list()

for (x in obj_to_integrate){
  if(unique(x@meta.data$sample_source) == "Organoid"){
    next
  }else{
    no_organoids <- c(no_organoids, x)
  }
}

#merge samples
merged_seurat <- merge(no_organoids[[1]], no_organoids[-1])
merged_seurat
```
This merged object has the following samples:
```{r, number-of-samples} 
unique(merged_seurat@meta.data$sample)
```
From these patients:
```{r, patients}
unique(merged_seurat@meta.data$patient_id)
```
And the samples sources are:
```{r, sample-sources}
unique(merged_seurat@meta.data$sample_source)
```
We are going to split data into layers by sample source, normalize, find variable features, scala data and run PCA analysis
```{r, split-samples-and-preprocesing}
#split into layers by sample source
merged_seurat[["RNA"]] <- split(merged_seurat[["originalexp"]], f = merged_seurat$sample_source)
DefaultAssay(merged_seurat) <- "RNA"
merged_seurat <- NormalizeData(merged_seurat)
merged_seurat <- FindVariableFeatures(merged_seurat)
merged_seurat <- ScaleData(merged_seurat)
merged_seurat <- RunPCA(merged_seurat)
```

```{r, elbowPlot}
ElbowPlot(merged_seurat, ndims = 30)
```
### Clustering with sample integration using anchors, resolution = 1
```{r, integrate-and-clustering-res-1}
merged_seurat <- IntegrateLayers(
  object = merged_seurat, method = CCAIntegration,
  orig.reduction = "pca", new.reduction = "integrated.cca",
  verbose = FALSE, assay = "RNA"
)

merged_seurat <- FindNeighbors(merged_seurat, reduction = "integrated.cca", dims = 1:30)
merged_seurat <- FindClusters(merged_seurat, resolution = 1, cluster.name = "cca_clusters")
merged_seurat <- RunUMAP(merged_seurat, reduction = "integrated.cca", dims = 1:30, reduction.name = "umap.cca", return.model = TRUE)
```
Clusters in this case are:

```{r, DimPlots-res-1}

DimPlot(
  merged_seurat,
  reduction = "umap.cca",
  group.by = c("sample_source"),
  label.size = 2
  )

DimPlot(
  merged_seurat,
  reduction = "umap.cca",
  group.by = c("cca_clusters"),
  label = TRUE
  ) & NoLegend()
```

### Clustering with sample integration using anchors, resolution = 0.8
```{r, clustering-res-0.8}

merged_seurat <- FindClusters(merged_seurat, resolution = 0.8, cluster.name = "cca_clusters")
merged_seurat <- RunUMAP(merged_seurat, reduction = "integrated.cca", dims = 1:30, reduction.name = "umap.cca", return.model = TRUE)

```
Clusters are:

```{r, DimPlots-res-0.8}

DimPlot(
  merged_seurat,
  reduction = "umap.cca",
  group.by = c("sample_source"),
  label.size = 2
  )

DimPlot(
  merged_seurat,
  reduction = "umap.cca",
  group.by = c("cca_clusters"),
  label = TRUE
  ) & NoLegend()
```
### Clustering with sample integration using anchors, resolution = 0.3
```{r, clustering-res-0.3}
merged_seurat <- FindClusters(merged_seurat, resolution = 0.3, cluster.name = "cca_clusters")
merged_seurat <- RunUMAP(merged_seurat, reduction = "integrated.cca", dims = 1:30, reduction.name = "umap.cca", return.model = TRUE)
```
Clusters in this case are:

```{r, DimPlots-res-0.3}

DimPlot(
  merged_seurat,
  reduction = "umap.cca",
  group.by = c("sample_source"),
  label.size = 2
  )

DimPlot(
  merged_seurat,
  reduction = "umap.cca",
  group.by = c("cca_clusters"),
  label = TRUE
  ) & NoLegend()
```


```{r, joinLayers-and-marker-definition}
merged_seurat <- JoinLayers(merged_seurat)
merged_seurat.markers <- FindAllMarkers(merged_seurat, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
#save markers for this object
saveRDS(merged_seurat.markers, file = "merged_seurat_no_organoids.markers.rds")

merged_seurat.markerstop1<-merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 1, order_by = avg_log2FC) #100 gives best results
  
merged_seurat.markerstop2<-merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 2, order_by = avg_log2FC) #100 gives best results
  
merged_seurat.markerstop100<-merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 100, order_by = avg_log2FC) #100  gives best results
  
merged_seurat.markerstop200<-merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 200, order_by = avg_log2FC) #200 gives second best results
  
merged_seurat.markerstop6<-merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 6, order_by = avg_log2FC) #100 gives best results
  
genesAll<-as.data.frame(merged_seurat.markerstop6$gene)
#unique(merged_seurat$seurat_clusters )
#unique(merged_seurat$cca_clusters)
#as.integer(levels(merged_seurat$seurat_clusters)) == c(0,1,2,3,4,5,6,9,10,11,12,13,14)
#length(levels(merged_seurat$seurat_clusters))
#c(0:length(levels(merged_seurat$seurat_clusters)))
#FeaturePlot(merged_seurat, features = merged_seurat.markerstop1$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], ncol = 3)
```
### Using first 1 top marker from each cluster
```{r, plot-markerstop1, fig.width=10, fig.height=20} 
#Visualize some markers
FeaturePlot(merged_seurat, features = merged_seurat.markerstop1$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], ncol = 3)
```

```{r, VlnPlot-markerstop1, fig.width=10, fig.height=30}
VlnPlot(merged_seurat, features = merged_seurat.markerstop1$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], 
        stack = TRUE, flip = TRUE ) & NoLegend()
```

```{r, heatmap-markerstop1, fig.width=24, fig.height=8}
DoHeatmap(merged_seurat, features = merged_seurat.markerstop1$gene) + NoLegend()
```
### Using first 2 top markers from each cluster
```{r, plot-markerstop2, fig.width=10, fig.height=20} 
#Visualize some markers
FeaturePlot(merged_seurat, features = merged_seurat.markerstop2$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], ncol = 3)
```

```{r, VlnPlot-markerstop2, fig.width=10, fig.height=20}
VlnPlot(merged_seurat, features = merged_seurat.markerstop2$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], 
        stack = TRUE, flip = TRUE ) & NoLegend()
```

```{r, heatmap-markerstop2,fig.width=24, fig.height=8}
DoHeatmap(merged_seurat, features = merged_seurat.markerstop2$gene) + NoLegend()
```

### Using first 6 top markers from each cluster
```{r, plot-markerstop6, fig.width=10, fig.height=20} 
#Visualize some markers
FeaturePlot(merged_seurat, features = merged_seurat.markerstop6$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], ncol = 3)
```

```{r, VlnPlot-markerstop6, fig.width=10, fig.height=20}
VlnPlot(merged_seurat, features = merged_seurat.markerstop6$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], 
        stack = TRUE, flip = TRUE ) & NoLegend()
```

```{r, heatmap-markerstop6, fig.width=24, fig.height=16}
DoHeatmap(merged_seurat, features = merged_seurat.markerstop6$gene) + NoLegend()
```

### Using first 100 top markers from each cluster
```{r, plot-markerstop100, fig.width=10, fig.height=20} 
#Visualize some markers
FeaturePlot(merged_seurat, features = merged_seurat.markerstop100$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], ncol = 3)
```

```{r, VlnPlot-markerstop100, fig.width=10, fig.height=20}
VlnPlot(merged_seurat, features = merged_seurat.markerstop100$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], 
        stack = TRUE, flip = TRUE ) & NoLegend()
```

```{r, heatmap-top10markerstop100, fig.width=24, fig.height=16}
merged_seurat.markerstop100 %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1) %>%
    slice_head(n = 10) %>%
    ungroup() -> top10
DoHeatmap(merged_seurat, features = top10$gene) + NoLegend()
```

```{r, function-cluster-annotation}
annotateMyClusters <- function(x, a, b, c, d){
  library(enrichR)
  input_library = x
  
  organismName = a
  #organismName = "Mus musculus"
  loaded.dataSO.combined.markerstop = b

  loaded.dataSO.combined = c 
  
  loaded.dataSO.combined.markers = d
  
  listEnrichrSites()
  
  if(getOption("enrichR.live")){
    setEnrichrSite("Enrichr") # Human genes
    
    annotatedclusters <-c()
    listofresults <-c()
    #listOfClusterAnnotationImages <<-list()
    if(organismName == "Mus musculus"){
      #for mouse:
      dbstouse <- c("PanglaoDB_Augmented_2021","CellMarker_Augmented_2021","Tabula_Muris")  
    }else{
      #for human:
      dbstouse <- c("PanglaoDB_Augmented_2021","CellMarker_Augmented_2021","Tabula_Sapiens", "MSigDB_Hallmark_2020", "MSigDB_Oncogenic_Signatures")
    }
    #m=2
    #input_library = "3"
    for(m in as.numeric(as.character(unique(loaded.dataSO.combined.markerstop$cluster)))){
    #for(m in c(1:length(as.numeric(as.character(unique(loaded.dataSO.combined.markerstop$cluster)))))){
      message(paste0("Working on cluster ", m+1, "/", length(unique(loaded.dataSO.combined.markerstop$cluster)), "\n"))
      markers_to_search<-loaded.dataSO.combined.markerstop$gene[loaded.dataSO.combined.markerstop$cluster==m]
      if (getOption("enrichR.live")) {
        #wait 1 sec
        Sys.sleep(1)
        enriched <- enrichr(markers_to_search, dbstouse)
        Sys.sleep(1)
      }else{message("Cannot resolve host: maayanlab.cloud. Check your internet connection and try again")}
      #Ismini: provide options for annotation DB e.g. celltype[1]== PanglaoDB_Augmented_2021, ccelltype[2]==CellMarker_Augmented_2021, celltype[3]==Tabula Sapiens or Muris
      celltype<-c(enriched[[1]]$Term[1],enriched[[2]]$Term[1],enriched[[3]]$Term[1], enriched[[4]]$Term[1], enriched[[5]]$Term[1])
      #print(paste("Cluster",m,celltype,sep = " "))
      if(input_library == "1"){
        annot_var = 1
      }else if(input_library == "2"){
        annot_var = 2
      }else if(input_library == "3"){
        annot_var = 3
      }else if(input_library == "4"){
        annot_var = 4
      }else if(input_library == "5"){
        annot_var = 5
      }
      annotatedclusters<-c(annotatedclusters,toString(make.names(celltype[annot_var])))
      #annotatedclusters<-c(annotatedclusters,toString(celltype[annot_var]))#using to Tabula Sapiens only to annotate
      names(enriched)<-paste(names(enriched),toString(make.names(celltype[annot_var])),sep = "_")
      #names(enriched)<-paste(names(enriched),toString(celltype[annot_var]),sep = "_")
      listofresults<-c(listofresults,enriched)
      #jpeg(file=paste("Annotation",celltype[annot_var],".jpg",sep=""),
       #    width=1200, height=800)

    }
  }else{message("Cannot resolve host: maayanlab.cloud. Check your internet connection and try again")}
  message("Finished annotation")
  
  #Rename indents 
  new.cluster.ids <- make.names(annotatedclusters,unique = T)
  names(annotatedclusters)
  #We have to rename the names(listofresults) the same way so we can plot them because in case there are two clusters named the same way i.e. "Fibroblast.Heart.CL.0000057" the previous
  #will change the name of the clusters to "Fibroblast.Heart.CL.0000057" and "Fibroblast.Heart.CL.0000057.1" in loaded.dataSO.combined$celltype but they will stay identical i.e. "Fibroblast.Heart.CL.0000057" for both in listofresults
  names(listofresults) <- make.names(names(listofresults), unique = TRUE)
  
  names(new.cluster.ids) <- levels(loaded.dataSO.combined)
  loaded.dataSO.combined <- RenameIdents(loaded.dataSO.combined, new.cluster.ids)
  #Change the Labels
  loaded.dataSO.combined$celltype.label <- paste(Idents(loaded.dataSO.combined), gsub("[0-9]+","",loaded.dataSO.combined$orig.ident), sep = "_")
  loaded.dataSO.combined$label <- gsub("[0-9]+","",loaded.dataSO.combined$orig.ident)
  
  loaded.dataSO.combined$celltype <- Idents(loaded.dataSO.combined)
  
  message("Renamed clusters. Cluster annotation completed.")
  
  return(list(loaded.dataSO.combined, loaded.dataSO.combined.markers, loaded.dataSO.combined.markerstop, listofresults))
}

annotation_res <- annotateMyClusters(3, "Homo sapiens", merged_seurat.markerstop100, merged_seurat, merged_seurat.markers)

#save seurat object, markers, markerstop and annotation results in an object
saveRDS(annotation_res, "Song_2022_annotation_results_no_organoids.rds")

```

### Cell type annotation results for each cluster
```{r, plot-annotation-res, fig.width=24, fig.height=16}
cell_type_clusters <- levels(annotation_res[1][[1]]$celltype)

enriched <- annotation_res[4][[1]]

for(x in cell_type_clusters){
 plot(
   plotEnrich(enriched[[paste("PanglaoDB_Augmented_2021_", x ,sep="")]],  numChar = 40, y = "Count", orderBy = "P.value",title = paste("PanglaoDB_cluster_", unique(annotation_res[1][[1]]$seurat_clusters[annotation_res[1][[1]]$celltype == x]))) +
        plotEnrich(enriched[[paste("CellMarker_Augmented_2021_", x ,sep="")]], numChar = 40, y = "Count", orderBy = "P.value",title = paste("CellMarker_cluster_", unique(annotation_res[1][[1]]$seurat_clusters[annotation_res[1][[1]]$celltype == x]))) +    
     plotEnrich(enriched[[paste("Tabula_Sapiens_", x ,sep="")]], numChar = 40, y = "Count", orderBy = "P.value",title = paste("Tabula_Sapiens_cluster_", unique(annotation_res[1][[1]]$seurat_clusters[annotation_res[1][[1]]$celltype == x]))) +
        plotEnrich(enriched[[paste("MSigDB_Hallmark_2020_", x ,sep="")]], numChar = 40, y = "Count", orderBy = "P.value",title = paste("MSigDB_Hallmark_2020_cluster_", unique(annotation_res[1][[1]]$seurat_clusters[annotation_res[1][[1]]$celltype == x]))) +
     plotEnrich(enriched[[paste("MSigDB_Oncogenic_Signatures_", x ,sep="")]], numChar = 40, y = "Count", orderBy = "P.value",title = paste("MSigDB_Oncogenic_Signatures_cluster_", unique(annotation_res[1][[1]]$seurat_clusters[annotation_res[1][[1]]$celltype == x])))
      )
}

```


### Available databases for annotation
```{r, available-dbs-enrichR}
setEnrichrSite("Enrichr")
dbs <- listEnrichrDbs()
dbs$libraryName
```

### Clusters projected on UMAP
```{r, UMAP-annotated-clusters, fig.width=7, fig.height=7}
DimPlot(annotation_res[1][[1]], reduction = "umap.cca", group.by = c("sample_source"), label.size = 2)
DimPlot(annotation_res[1][[1]], reduction = "umap.cca", group.by = c("celltype") ,label = TRUE, label.size = 2) & NoLegend()
```

