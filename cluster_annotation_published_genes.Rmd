---
title: "cluster annotation paper gene lists"
author: "Ismini"
date: "2025-08-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(SeuratObject)
library(dplyr)
library(ggplot2)
library(patchwork)
library(readxl)
library(RColorBrewer)
library(decoupleR)
library(OmnipathR)
library(clustree)
```

```{r, read-data}
annotation_res <- readRDS(file = "Song_2022_annotation_results_no_organoids.rds")
cell_type_genesets <- read_xlsx("annotations_Song_2022.xlsx", sheet = "Normal Signature")
```

```{r, addModuleScores}, warning= FALSE, message= FALSE}
merged_seurat <- annotation_res[[1]]
merged_seurat <- AddModuleScore(merged_seurat,
                  features = as.list(cell_type_genesets),
                  name = names(as.list(cell_type_genesets))
  )

#names(merged_seurat@meta.data)
```

Using the annotation for Normal Signatures from Song et al., we see that we have annotated some different subtypes of epithelial cells, basal epithelial, club cells, Hillock cells and luminal epithelial cells.

```{r, plot_clusters, fig.width=10, fig.height=60, warning= FALSE, message= FALSE}
FeaturePlot(merged_seurat,, ncol = 1,
            features = names(merged_seurat@meta.data[24:34]), label = TRUE, repel = TRUE, order =TRUE) &
            scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu" ))) & labs(subtitle = "Normal Signature") &  theme(plot.subtitle = element_text(hjust = 0.5, size = 12) )

```

```{r, Erf_expression, warning= FALSE, message= FALSE}
FeaturePlot(merged_seurat,, ncol = 1,
            features = "ERF", label = TRUE, repel = TRUE, order =TRUE) &
            scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu" ))) & labs(subtitle = "Normal Signature") &  theme(plot.subtitle = element_text(hjust = 0.5, size = 12) )
```

```{r, Erf_Erg_expression, warning= FALSE, message= FALSE}
VlnPlot(merged_seurat, features = c("ERF", "ERG"), group.by = "sample_source", split.by = "seurat_clusters", stack = TRUE, flip = TRUE)
DotPlot(merged_seurat, features = c("ERF", "ERG"), group.by = "sample_source", split.by = "seurat_clusters", cols = "RdBu")

```

From dorothea we take 3 genes associated with ERF expression, EGR1, MYCN and RARA. Also we see that KRT8, KRT18 characterizing luminal epithelial cells are mostly expressed in clusters 0,1,2,5,6 and KRT5 that characterizes basal epithelial cells is highly expressed among cells of cluster 2.

```{r, Erf-expression-inference-dorothe-decoupleR, warning= FALSE, message= FALSE, echo = FALSE}
net <- decoupleR::get_dorothea(organism='human', levels = c("A", "B", "C"))

erf_net_genes <- net[c(10764,21576, 23811), "source"]


DefaultAssay(object = merged_seurat) <- "RNA"
VlnPlot(merged_seurat, features = c("ERF", erf_net_genes$source, "KRT8", "KRT18",  "KRT5", "KRT14", "KRT13"), group.by = "celltype", stack = TRUE, flip = TRUE) + NoLegend()

```

We search for gene sets from the MsigDB with genes expressed in PCa samples and add scores for the average expression of these gene sets in our clusters (with AddModuleScore function from Seurat)
```{r, addModuleScore-from-C2-gen-sets-from-msigDB, warning= FALSE, message= FALSE, echo=FALSE}
library(msigdbr)
c2_gene_sets <- msigdbr(
  db_species = "HS",
  species = "human",
  collection = "C2"
)

c2_cgp_gene_sets <- msigdbr(
  db_species = "HS",
  species = "human",
  collection = "C2",
  subcollection = "CGP"
)

c2_PCa_gene_sets <- unique(c2_gene_sets[grep("prostate cancer", c2_gene_sets$gs_description), "gs_description"])

c2_cgp_PCa_gene_sets <- unique(c2_cgp_gene_sets[grep("prostate cancer", c2_cgp_gene_sets$gs_description), "gs_description"])
#unique(c(c2_PCa_gene_sets$gs_description, c2_cgp_PCa_gene_sets$gs_description))
#c2_cgp_PCa_gene_sets$gs_description %in% c2_PCa_gene_sets$gs_description

#x = "Genes down-regulated in RWPE-1 cells (prostate cancer) upon expression of constitutively active form of STAT3 [GeneID=6774]."
if(FALSE){
for(x in c2_PCa_gene_sets$gs_description){
    flag <- TRUE
  merged_seurat <- tryCatch( 

    {
    AddModuleScore(merged_seurat,
                  features = unique(c2_gene_sets$gene_symbol[which(c2_gene_sets$gs_description == x)]),
                  name = x
                  )
    },
  error = function(e) {
    flag<<-FALSE
    },
  warning = function(w) {
            message(conditionMessage(w))
            # Choose a return value in case of warning
            flag<<-FALSE
            return(merged_seurat)
    }
  )
  if (!flag) next
}
}
#make a list of lists for genes of c2_PCa_gene_sets to use it in AddModuleScore
c2_PCa_gene_list = list()
for(x in c2_PCa_gene_sets$gs_description){
  c2_PCa_gene_list[[x]] <- unique(c2_gene_sets$gene_symbol[which(c2_gene_sets$gs_description == x)])
}
#c2_PCa_gene_list$`Selected genes up-regulated in DU145 and PC-3 cells (prostate cancer) after treatment with the NSAID (non-steroid anti-inflammatory drug) sulindac [PubChem=5352].`
#c2_PCa_gene_list$`Genes down-regulated in RWPE-1 cells (prostate cancer) upon expression of constitutively active form of STAT3 [GeneID=6774].`
DefaultAssay(object = merged_seurat) <- "RNA"

merged_seurat <- AddModuleScore(merged_seurat,
                  features = c2_PCa_gene_list,
                  name = names(as.list(c2_PCa_gene_list))
                  )

#names(merged_seurat@meta.data)
```

```{r, plot_clusters_PCa_enriched, warning= FALSE, message= FALSE}
#fig.width=10, fig.height=200, warning= FALSE, message= FALSE}
library(ggtext)
if(FALSE){#don't run this cell
#next FALSE section is for printing before knitting. 
if(FALSE){
FeaturePlot(merged_seurat, ncol = 1, label.size = 2, 
            features = names(merged_seurat@meta.data[35:109]), label = TRUE, repel = TRUE, order =TRUE) &
            scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu" ))) & labs(subtitle = "PCa gene sets from MsigDB") &  theme(plot.title =element_textbox_simple(size = 10, hjust = 0.5), plot.subtitle = element_text(hjust = 0.5, size = 8)) 
}
#the following works when knitting
plot_feature_batches <- function(seurat_obj, features, batch_size = 3, ncol = 1) {
  batches <- split(features, ceiling(seq_along(features) / batch_size))
  plots <- list()
  
  for (i in seq_along(batches)) {
    p <- FeaturePlot(
      seurat_obj,
      features = batches[[i]],
      ncol = ncol,
      label = TRUE,
      label.size = 2,
      repel = TRUE,
      order = TRUE
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = "PCa gene sets from MsigDB") &
      theme(
        plot.title = element_textbox_simple(size = 10, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 8)
      )
    
    plots[[i]] <- p
  }
  
  return(plots)
}

features_all <- names(merged_seurat@meta.data[35:109])
feature_plots <- plot_feature_batches(merged_seurat, features_all, batch_size = 1, ncol = 1)

for (p in feature_plots) {
  print(p)
}
#don't run this cell
}
```

```{r, VlnPlot, fig.height= 12, fig.width= 25, warning= FALSE, message= FALSE, include = FALSE}
if(FALSE){
VlnPlot(merged_seurat, features = "Genes expressed in at least one prostate cancer cell line but not in normal prostate epithelial cells or stromal cells72", group.by = "celltype", split.by = "sample_source")
}
```


```{r, dorothea-decoupleR-lmodel, warning= FALSE, message= FALSE, include = FALSE}
if(FALSE){
### the following uses 31GB of RAM
#mat <- as.matrix(merged_seurat@assays$originalexp@data)

# Run ulm
acts <- run_ulm(mat=mat, net=net, .source='source', .target='target',
                .mor='mor', minsize = 5)
merged_seurat[['tfsulm']] <- acts %>%
  pivot_wider(id_cols = 'source', names_from = 'condition',
              values_from = 'score') %>%
  column_to_rownames('source') %>%
  Seurat::CreateAssayObject(.)

# Change assay
DefaultAssay(object = merged_seurat) <- "tfsulm"

# Scale the data
merged_seurat <- ScaleData(merged_seurat)
merged_seurat@assays$tfsulm@data <- merged_seurat@assays$tfsulm@scale.data

#Plot Erf 
p1 <- DimPlot(merged_seurat, reduction = "umap", label = TRUE, pt.size = 0.5) + 
  NoLegend() + ggtitle('Cell types')
p2 <- (FeaturePlot(data, features = c("ERF")) & 
  scale_colour_gradient2(low = 'blue', mid = 'white', high = 'red')) +
  ggtitle('Erf activity')
DefaultAssay(object = merged_seurat) <- "RNA"
p3 <- FeaturePlot(merged_seurat, features = c("ERF")) + ggtitle('Erf expression')
DefaultAssay(object = merged_seurat) <- "tfsulm"
p1 | p2 | p3
}
```

We are going to search for sub-populations of cells within clusters 0,1,2,5 and 6. We can see that a resolution of 0.8 returns stable clusters

```{r, subpopylation-clustering, warning= FALSE, message= FALSE, echo = FALSE}
Idents(merged_seurat) <- "cca_clusters"
epith_merged_seurat <- subset(merged_seurat, idents = c("0", "1", "2", "5", "6"))
epith_merged_seurat
epith_merged_seurat[["RNA"]] <- split(epith_merged_seurat[["originalexp"]], f = epith_merged_seurat$sample_source)
DefaultAssay(epith_merged_seurat) <- "RNA"
epith_merged_seurat <- NormalizeData(epith_merged_seurat)
epith_merged_seurat <- FindVariableFeatures(epith_merged_seurat)
epith_merged_seurat <- ScaleData(epith_merged_seurat)
epith_merged_seurat <- RunPCA(epith_merged_seurat)
ElbowPlot(epith_merged_seurat, ndims = 30)
epith_merged_seurat <- IntegrateLayers(
  object = epith_merged_seurat, method = CCAIntegration,
  orig.reduction = "pca", new.reduction = "integrated.cca",
  verbose = FALSE, assay = "RNA"
)

epith_merged_seurat <- FindNeighbors(epith_merged_seurat, reduction = "integrated.cca", dims = 1:30)
epith_merged_seurat <- FindClusters(epith_merged_seurat, resolution = c(0.3,0.5,0.6,0.7,0.8,0.9,1.0,1.1,1.2,1.3,1.4,1.5,2))
clustree(epith_merged_seurat)
```

```{r, clustering-0.8_res-epith}, warning= FALSE, message= FALSE, echo=FALSE}
epith_merged_seurat <- FindClusters(epith_merged_seurat, resolution = 0.8, cluster.name = "cca_clusters")
epith_merged_seurat <- RunUMAP(epith_merged_seurat, reduction = "integrated.cca", dims = 1:30, reduction.name = "umap.cca", return.model = TRUE)

DimPlot(
  epith_merged_seurat,
  reduction = "umap.cca",
  group.by = c("sample_source"),
  label.size = 2
  )

DimPlot(
  epith_merged_seurat,
  reduction = "umap.cca",
  group.by = c("cca_clusters"),
  label = TRUE
  ) & NoLegend()
```

```{r, annotation-epith, warning= FALSE, message= FALSE, echo = FALSE}
epith_merged_seurat <- JoinLayers(epith_merged_seurat)
epith_merged_seurat.markers <- FindAllMarkers(epith_merged_seurat, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
#save markers for this object
saveRDS(epith_merged_seurat.markers, file = "epith_merged_seurat_no_organoids.markers.rds")

epith_merged_seurat.markerstop1<-epith_merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 1, order_by = avg_log2FC) #100 gives best results
  
epith_merged_seurat.markerstop2<-epith_merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 2, order_by = avg_log2FC) #100 gives best results
  
epith_merged_seurat.markerstop100<-epith_merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 100, order_by = avg_log2FC) #100  gives best results
  
epith_merged_seurat.markerstop200<-epith_merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 200, order_by = avg_log2FC) #200 gives second best results
  
epith_merged_seurat.markerstop6<-epith_merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 6, order_by = avg_log2FC) #100 gives best results
  
genesAll<-as.data.frame(epith_merged_seurat.markerstop6$gene)
#unique(merged_seurat$seurat_clusters )
#unique(merged_seurat$cca_clusters)
#as.integer(levels(merged_seurat$seurat_clusters)) == c(0,1,2,3,4,5,6,9,10,11,12,13,14)
#length(levels(merged_seurat$seurat_clusters))
#c(0:length(levels(merged_seurat$seurat_clusters)))
#FeaturePlot(merged_seurat, features = merged_seurat.markerstop1$gene[c(0:length(levels(merged_seurat$seurat_clusters)))], ncol = 3)
```
### Using first 1 top marker from each cluster
```{r, plot-markerstop1-epith, fig.width=10, fig.height=20, warning= FALSE, message= FALSE} 
#Visualize some markers
FeaturePlot(epith_merged_seurat, features = epith_merged_seurat.markerstop1$gene[c(0:length(levels(epith_merged_seurat$seurat_clusters)))], ncol = 3)
```

```{r, VlnPlot-markerstop1-epith, fig.width=10, fig.height=30, warning= FALSE, message= FALSE, include = FALSE}
#VlnPlot(epith_merged_seurat, features = epith_merged_seurat.markerstop1$gene[c(0:length(levels(epith_merged_seurat$seurat_clusters)))], stack = TRUE, flip = TRUE ) & NoLegend()
#DotPlot(epith_merged_seurat, features = epith_merged_seurat.markerstop1$gene[c(0:length(levels(epith_merged_seurat$seurat_clusters)))])
```

```{r, heatmap-markerstop1-epith, fig.width=24, fig.height=8, warning= FALSE, message= FALSE}
DoHeatmap(epith_merged_seurat, features = epith_merged_seurat.markerstop1$gene) + NoLegend()
```
### Using first 2 top markers from each cluster
```{r, plot-markerstop2-epith, fig.width=10, fig.height=20, warning= FALSE, message= FALSE} 
#Visualize some markers
FeaturePlot(epith_merged_seurat, features = epith_merged_seurat.markerstop2$gene[c(0:length(levels(epith_merged_seurat$seurat_clusters)))], ncol = 3)
```

```{r, VlnPlot-markerstop2-epith, fig.width=10, fig.height=20, warning= FALSE, message= FALSE, include = FALSE}
#VlnPlot(epith_merged_seurat, features = epith_merged_seurat.markerstop2$gene[c(0:length(levels(epith_merged_seurat$seurat_clusters)))], stack = TRUE, flip = TRUE ) & NoLegend()
```

```{r, heatmap-markerstop2-epith,fig.width=24, fig.height=8, warning= FALSE, message= FALSE}
DoHeatmap(epith_merged_seurat, features = epith_merged_seurat.markerstop2$gene) + NoLegend()
```

### Using first 6 top markers from each cluster
```{r, plot-markerstop6-epith, fig.width=10, fig.height=20, warning= FALSE, message= FALSE} 
#Visualize some markers
FeaturePlot(epith_merged_seurat, features = epith_merged_seurat.markerstop6$gene[c(0:length(levels(epith_merged_seurat$seurat_clusters)))], ncol = 3)
```

```{r, VlnPlot-markerstop6-epith, fig.width=10, fig.height=20, warning= FALSE, message= FALSE, include=FALSE}
#VlnPlot(epith_merged_seurat, features = epith_merged_seurat.markerstop6$gene[c(0:length(levels(epith_merged_seurat$seurat_clusters)))], stack = TRUE, flip = TRUE ) & NoLegend()
```

```{r, heatmap-markerstop6-epith, fig.width=24, fig.height=16, warning= FALSE, message= FALSE}
DoHeatmap(epith_merged_seurat, features = epith_merged_seurat.markerstop6$gene) + NoLegend()
```

### Using first 100 top markers from each cluster
```{r, plot-markerstop100-epith, fig.width=10, fig.height=20, warning= FALSE, message= FALSE} 
#Visualize some markers
FeaturePlot(epith_merged_seurat, features = epith_merged_seurat.markerstop100$gene[c(0:length(levels(epith_merged_seurat$seurat_clusters)))], ncol = 3)
```

```{r, VlnPlot-markerstop100-epith, fig.width=10, fig.height=20, warning= FALSE, message= FALSE, include =FALSE}
#VlnPlot(epith_merged_seurat, features = epith_merged_seurat.markerstop100$gene[c(0:length(levels(epith_merged_seurat$seurat_clusters)))], stack = TRUE, flip = TRUE ) & NoLegend()
```

```{r, heatmap-top10markerstop100-epith, fig.width=24, fig.height=16, warning= FALSE, message= FALSE}
epith_merged_seurat.markerstop100 %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1) %>%
    slice_head(n = 10) %>%
    ungroup() -> top10
DoHeatmap(epith_merged_seurat, features = top10$gene) + NoLegend()

```
We are going to annotate these clusters with enrichR using PanglaoDB_Augmented_2021, CellMarker_Augmented_2021, Tabula_Sapiens, MSigDB_Hallmark_2020, MSigDB_Oncogenic_Signatures
```{r, annotate-clusters-epith, warning= FALSE, message= FALSE, echo = FALSE}
annotateMyClusters <- function(x, a, b, c, d){
  library(enrichR)
  input_library = x
  
  organismName = a
  #organismName = "Mus musculus"
  loaded.dataSO.combined.markerstop = b

  loaded.dataSO.combined = c 
  
  loaded.dataSO.combined.markers = d
  
  listEnrichrSites()
  
  if(getOption("enrichR.live")){
    setEnrichrSite("Enrichr") # Human genes
    
    annotatedclusters <-c()
    listofresults <-c()
    #listOfClusterAnnotationImages <<-list()
    if(organismName == "Mus musculus"){
      #for mouse:
      dbstouse <- c("PanglaoDB_Augmented_2021","CellMarker_Augmented_2021","Tabula_Muris")  
    }else{
      #for human:
      dbstouse <- c("PanglaoDB_Augmented_2021","CellMarker_Augmented_2021","Tabula_Sapiens", "MSigDB_Hallmark_2020", "MSigDB_Oncogenic_Signatures")
    }
    #m=2
    #input_library = "3"
    for(m in as.numeric(as.character(unique(loaded.dataSO.combined.markerstop$cluster)))){
    #for(m in c(1:length(as.numeric(as.character(unique(loaded.dataSO.combined.markerstop$cluster)))))){
      message(paste0("Working on cluster ", m+1, "/", length(unique(loaded.dataSO.combined.markerstop$cluster)), "\n"))
      markers_to_search<-loaded.dataSO.combined.markerstop$gene[loaded.dataSO.combined.markerstop$cluster==m]
      if (getOption("enrichR.live")) {
        #wait 1 sec
        Sys.sleep(1)
        enriched <- enrichr(markers_to_search, dbstouse)
        Sys.sleep(1)
      }else{message("Cannot resolve host: maayanlab.cloud. Check your internet connection and try again")}
      #Ismini: provide options for annotation DB e.g. celltype[1]== PanglaoDB_Augmented_2021, ccelltype[2]==CellMarker_Augmented_2021, celltype[3]==Tabula Sapiens or Muris
      celltype<-c(enriched[[1]]$Term[1],enriched[[2]]$Term[1],enriched[[3]]$Term[1], enriched[[4]]$Term[1], enriched[[5]]$Term[1])
      #print(paste("Cluster",m,celltype,sep = " "))
      if(input_library == "1"){
        annot_var = 1
      }else if(input_library == "2"){
        annot_var = 2
      }else if(input_library == "3"){
        annot_var = 3
      }else if(input_library == "4"){
        annot_var = 4
      }else if(input_library == "5"){
        annot_var = 5
      }
      annotatedclusters<-c(annotatedclusters,toString(make.names(celltype[annot_var])))
      #annotatedclusters<-c(annotatedclusters,toString(celltype[annot_var]))#using to Tabula Sapiens only to annotate
      names(enriched)<-paste(names(enriched),toString(make.names(celltype[annot_var])),sep = "_")
      #names(enriched)<-paste(names(enriched),toString(celltype[annot_var]),sep = "_")
      listofresults<-c(listofresults,enriched)
      #jpeg(file=paste("Annotation",celltype[annot_var],".jpg",sep=""),
       #    width=1200, height=800)

    }
  }else{message("Cannot resolve host: maayanlab.cloud. Check your internet connection and try again")}
  message("Finished annotation")
  
  #Rename indents 
  new.cluster.ids <- make.names(annotatedclusters,unique = T)
  names(annotatedclusters)
  #We have to rename the names(listofresults) the same way so we can plot them because in case there are two clusters named the same way i.e. "Fibroblast.Heart.CL.0000057" the previous
  #will change the name of the clusters to "Fibroblast.Heart.CL.0000057" and "Fibroblast.Heart.CL.0000057.1" in loaded.dataSO.combined$celltype but they will stay identical i.e. "Fibroblast.Heart.CL.0000057" for both in listofresults
  names(listofresults) <- make.names(names(listofresults), unique = TRUE)
  
  names(new.cluster.ids) <- levels(loaded.dataSO.combined)
  loaded.dataSO.combined <- RenameIdents(loaded.dataSO.combined, new.cluster.ids)
  #Change the Labels
  loaded.dataSO.combined$celltype.label <- paste(Idents(loaded.dataSO.combined), gsub("[0-9]+","",loaded.dataSO.combined$orig.ident), sep = "_")
  loaded.dataSO.combined$label <- gsub("[0-9]+","",loaded.dataSO.combined$orig.ident)
  
  loaded.dataSO.combined$celltype <- Idents(loaded.dataSO.combined)
  
  message("Renamed clusters. Cluster annotation completed.")
  
  return(list(loaded.dataSO.combined, loaded.dataSO.combined.markers, loaded.dataSO.combined.markerstop, listofresults))
}

annotation_res_epith <- annotateMyClusters(3, "Homo sapiens", epith_merged_seurat.markerstop100, epith_merged_seurat, epith_merged_seurat.markers)

#save seurat object, markers, markerstop and annotation results in an object
#saveRDS(annotation_res_epith, "Song_2022_annotation_results_epithelial_no_organoids.rds")

```

### Cell type annotation results for each cluster
```{r, plot-annotation-res-epith, fig.width=24, fig.height=16, warning= FALSE, message= FALSE}
cell_type_clusters_epith <- levels(annotation_res_epith[1][[1]]$celltype)

enriched_epith <- annotation_res_epith[4][[1]]

for(x in cell_type_clusters_epith){
 plot(
   plotEnrich(enriched_epith[[paste("PanglaoDB_Augmented_2021_", x ,sep="")]],  numChar = 40, y = "Count", orderBy = "P.value",title = paste("PanglaoDB_cluster_", unique(annotation_res_epith[1][[1]]$seurat_clusters[annotation_res_epith[1][[1]]$celltype == x]))) +
        plotEnrich(enriched_epith[[paste("CellMarker_Augmented_2021_", x ,sep="")]], numChar = 40, y = "Count", orderBy = "P.value",title = paste("CellMarker_cluster_", unique(annotation_res_epith[1][[1]]$seurat_clusters[annotation_res_epith[1][[1]]$celltype == x]))) +    
     plotEnrich(enriched_epith[[paste("Tabula_Sapiens_", x ,sep="")]], numChar = 40, y = "Count", orderBy = "P.value",title = paste("Tabula_Sapiens_cluster_", unique(annotation_res_epith[1][[1]]$seurat_clusters[annotation_res_epith[1][[1]]$celltype == x]))) +
        plotEnrich(enriched_epith[[paste("MSigDB_Hallmark_2020_", x ,sep="")]], numChar = 40, y = "Count", orderBy = "P.value",title = paste("MSigDB_Hallmark_2020_cluster_", unique(annotation_res_epith[1][[1]]$seurat_clusters[annotation_res_epith[1][[1]]$celltype == x]))) +
     plotEnrich(enriched_epith[[paste("MSigDB_Oncogenic_Signatures_", x ,sep="")]], numChar = 40, y = "Count", orderBy = "P.value",title = paste("MSigDB_Oncogenic_Signatures_cluster_", unique(annotation_res_epith[1][[1]]$seurat_clusters[annotation_res_epith[1][[1]]$celltype == x])))
      )
}

```

### Clusters projected on UMAP
```{r, UMAP-annotated-clusters-epith, fig.width=7, fig.height=7, warning= FALSE, message= FALSE}
DimPlot(annotation_res_epith[1][[1]], reduction = "umap.cca", group.by = c("sample_source"), label.size = 3)
DimPlot(annotation_res_epith[1][[1]], reduction = "umap.cca", group.by = c("celltype") ,label = TRUE, label.size = 3, repel = TRUE) & NoLegend()
```

```{r, warning= FALSE, message= FALSE, echo =FALSE}
epith_merged_seurat <- annotation_res_epith[[1]]
epith_merged_seurat <- AddModuleScore(epith_merged_seurat,
                  features = as.list(cell_type_genesets),
                  name = names(as.list(cell_type_genesets))
  )

#names(epith_merged_seurat@meta.data)
```

Using the annotation for Normal Signatures from Song et al., we see that we have annotated some different subtypes of epithelial cells, basal epithelial, club cells, Hillock cells and luminal epithelial cells.

```{r, plot_clusters_epith, fig.width=10, fig.height=60, warning= FALSE, message= FALSE}
FeaturePlot(epith_merged_seurat,, ncol = 1,
            features = names(epith_merged_seurat@meta.data[24:34]), label = TRUE, repel = TRUE, order =TRUE) &
            scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu" ))) & labs(subtitle = "Normal Signature") &  theme(plot.subtitle = element_text(hjust = 0.5, size = 12) )

```

```{r, Erf_expression_epith, warning= FALSE, message= FALSE, include = FALSE}
if(FALSE){
FeaturePlot(epith_merged_seurat,, ncol = 1,
            features = "ERF", label = TRUE, repel = TRUE, order =TRUE) &
            scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu" ))) & labs(subtitle = "Normal Signature") &  theme(plot.subtitle = element_text(hjust = 0.5, size = 12) )
}
```

```{r, Erf_Erg_expression_epith, warning= FALSE, message= FALSE, include=FALSE}
#VlnPlot(epith_merged_seurat, features = c("ERF", "ERG"), group.by = "seurat_clusters", stack = TRUE, flip = TRUE)
```

Again we can inspect the expression of ERF, EGR1, MYCN and RARA, KRT8, KRT18 and KRT5.

```{r, Erf-expression, warning= FALSE, message= FALSE}
#net <- decoupleR::get_dorothea(organism='human', levels = c("A", "B", "C"))

#erf_net_genes <- net[c(10764,21576, 23811), "source"]


DefaultAssay(object = epith_merged_seurat) <- "RNA"

#VlnPlot(epith_merged_seurat, features = c("ERF", erf_net_genes$source, "KRT8", "KRT5"), group.by = "seurat_clusters", stack = TRUE, flip = TRUE) + NoLegend()
VlnPlot(epith_merged_seurat, features = c("ERF", erf_net_genes$source, "KRT8", "KRT18",  "KRT5", "KRT14", "KRT13"), group.by = "celltype", stack = TRUE, flip = TRUE) + NoLegend()
```

### Using only coding genes
We are going to proceed in sub-population clustering using only the expression of protein coding genes

```{r, keeponly-coding-genes, warning= FALSE, message= FALSE, echo = FALSE}
load("../annotations_hsap.Rda")
#names(annotations)
prot_coding_genes <- annotations %>% 
      dplyr::filter(gene_biotype == "protein_coding") %>%
      dplyr::pull(gene_name)
length(unique(prot_coding_genes))

cod_epith_merged_seurat <- DietSeurat(
  epith_merged_seurat,
  layers = NULL,
  features = prot_coding_genes,
  assays = "RNA",
  dimreducs = NULL,
  graphs = NULL
)
cod_epith_merged_seurat[["RNA"]] <- split(cod_epith_merged_seurat[["RNA"]], f = cod_epith_merged_seurat$sample_source)
DefaultAssay(cod_epith_merged_seurat) <- "RNA"
cod_epith_merged_seurat <- NormalizeData(cod_epith_merged_seurat)
cod_epith_merged_seurat <- FindVariableFeatures(cod_epith_merged_seurat)
cod_epith_merged_seurat <- ScaleData(cod_epith_merged_seurat)
cod_epith_merged_seurat <- RunPCA(cod_epith_merged_seurat)
ElbowPlot(cod_epith_merged_seurat, ndims = 30)
cod_epith_merged_seurat <- IntegrateLayers(
  object = cod_epith_merged_seurat, method = CCAIntegration,
  orig.reduction = "pca", new.reduction = "integrated.cca",
  verbose = FALSE, assay = "RNA"
)

cod_epith_merged_seurat <- FindNeighbors(cod_epith_merged_seurat, reduction = "integrated.cca", dims = 1:30)
cod_epith_merged_seurat <- FindClusters(cod_epith_merged_seurat, resolution = c(0.3,0.5,0.6,0.7,0.8,0.9,1.0,1.1,1.2,1.3,1.4,1.5,2))

clustree(cod_epith_merged_seurat)
```

We see that a resolution of 1.4 gives sufficient clusters.

```{r, warning= FALSE, message= FALSE, echo = FALSE}

cod_epith_merged_seurat <- FindClusters(cod_epith_merged_seurat, resolution = 1.4, cluster.name = "cca_clusters")
cod_epith_merged_seurat <- RunUMAP(cod_epith_merged_seurat, reduction = "integrated.cca", dims = 1:30, reduction.name = "umap.cca", return.model = TRUE)

DimPlot(
  cod_epith_merged_seurat,
  reduction = "umap.cca",
  group.by = c("sample_source"),
  label.size = 2
  )

DimPlot(
  cod_epith_merged_seurat,
  reduction = "umap.cca",
  group.by = c("cca_clusters"),
  label = TRUE
  ) & NoLegend()
```
We can see the expression of some top markers (violin plot) and top 10 markers from each cluster (dot plot).

```{r, apply-paper-annotation, warning= FALSE, message= FALSE, echo = FALSE}
cod_epith_merged_seurat <- JoinLayers(cod_epith_merged_seurat)
cod_epith_merged_seurat.markers <- FindAllMarkers(cod_epith_merged_seurat, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
#save markers for this object
#saveRDS(cod_epith_merged_seurat.markers, file = "coding_epith_merged_seurat_no_organoids.markers.rds")

cod_epith_merged_seurat.markerstop100<-cod_epith_merged_seurat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 100, order_by = avg_log2FC) #100 gives best results
  

VlnPlot(cod_epith_merged_seurat, features = cod_epith_merged_seurat.markerstop100$gene[c(0:length(levels(cod_epith_merged_seurat$seurat_clusters)))], 
        stack = TRUE, flip = TRUE ) & NoLegend()



cod_epith_merged_seurat.markerstop100 %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1) %>%
    slice_head(n = 10) %>%
    ungroup() -> top10
#DoHeatmap(cod_epith_merged_seurat, features = top10$gene) + theme(axis.text=element_text(size=5)) + NoLegend()
DotPlot(cod_epith_merged_seurat, features = unique(top10$gene)) & theme(axis.text=element_text(size=5)) & NoLegend()
```
Now, we can use the markers from Song et al. to distinguish LE cells from the other cell types.
```{r, warning= FALSE, message= FALSE, echo = FALSE}
#paper annotations
cod_epith_merged_seurat <- AddModuleScore(cod_epith_merged_seurat,
                  features = as.list(cell_type_genesets),
                  name = names(as.list(cell_type_genesets))
  )
features_all <- names(cod_epith_merged_seurat@meta.data[24:34])
for(x in features_all){
p <- FeaturePlot(cod_epith_merged_seurat,, ncol = 1,
            features = x, label = TRUE, repel = TRUE, order =TRUE) &
            scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu" ))) & labs(subtitle = "Normal Signature") &  theme(plot.subtitle = element_text(hjust = 0.5, size = 12) )

print(p)
}
```

We see that LE cells are in clusters 0-7 and 13-19, whereas cluster 12 has endothelial cells apart from luminal epithelial. Clusters 8,11 have mostly basal epithelial, cluster 9 Hillock cells and in cluster 10 we see both basal epithelial and Hillock cells.

```{r, annotate_clusters, warning= FALSE, message= FALSE, echo = FALSE}

#new_names <- c(rep("LE",8), "BE", "Hillock", "BE & Hillock", "BE", "Endothelial & LE", rep("LE", 7))
#names(new_names) <- levels(cod_epith_merged_seurat)
#cod_epith_merged_seurat <- RenameIdents(object = cod_epith_merged_seurat, new_names)

levels(cod_epith_merged_seurat)

cod_epith_merged_seurat@meta.data$manual_annotation <- as.vector(cod_epith_merged_seurat@meta.data$cca_clusters)
cod_epith_merged_seurat@meta.data$manual_annotation[cod_epith_merged_seurat@meta.data$cca_clusters %in% c(8,11)] <- "BE"
cod_epith_merged_seurat@meta.data$manual_annotation[cod_epith_merged_seurat@meta.data$cca_clusters %in% c(10)] <- "BE & Hillock"
cod_epith_merged_seurat@meta.data$manual_annotation[cod_epith_merged_seurat@meta.data$cca_clusters %in% c(9)] <- "Hillock"
cod_epith_merged_seurat@meta.data$manual_annotation[cod_epith_merged_seurat@meta.data$cca_clusters %in% c(0:7, 13:19)] <- "LE"
cod_epith_merged_seurat@meta.data$manual_annotation[cod_epith_merged_seurat@meta.data$cca_clusters %in% c(12)] <- "Endothelial & LE"

DimPlot(
  cod_epith_merged_seurat,
  reduction = "umap.cca",
  group.by = c("sample_source"),
  label.size = 2
  )

DimPlot(
  cod_epith_merged_seurat,
  reduction = "umap.cca",
  group.by = "manual_annotation",
  label = TRUE
  ) & NoLegend()
```

Adding module scores for gene sets related with PCa from MsigDB we see that "Genes up-regulated in prostate cancer samples" (fig.17) show expression in LE cells in comparison with "Genes down-regulated in prostate cancer samples" (fig.16). The same applies for "Genes up-regulated in prostate cancer vs benign prostate tissue, based on a meta-analysis of five gene expression profiling studies" (fig.48) versus "Genes down-regulated in prostate cancer vs benign prostate tissue, based on a meta-analysis of five gene expression profiling studies" (fig.47). We can also see a higher expression of genes among LE cells that are up regulated in samples with fusions of TMPRSS2-ERG (fig.41) versus the expression of those down regulated in samples with the TMPRSS2-ERG fusion (fig.40). Moreover, there are genes expressed among LE cells that were found to alter their expression between androgen independent vs androgen dependent samples (fig.52). Finally, we find a higher expression of genes in LE cells that are up-regulated in LNCaP cells (prostate cancer) in response to synthetic androgen R1881 [PubChem=13766] (fig.27).


```{r, module-score-MsigDB, warning= FALSE, message= FALSE, echo = FALSE}
#C2 gene sets from MsigDB
#names(cod_epith_merged_seurat@meta.data)[34+27]
cod_epith_merged_seurat <- AddModuleScore(cod_epith_merged_seurat,
                  features = c2_PCa_gene_list,
                  name = names(as.list(c2_PCa_gene_list))
                  )
plot_feature_batches <- function(seurat_obj, features, batch_size = 3, ncol = 1) {
  batches <- split(features, ceiling(seq_along(features) / batch_size))
  plots <- list()
  
  for (i in seq_along(batches)) {
    p <- FeaturePlot(
      seurat_obj,
      features = batches[[i]],
      ncol = ncol,
      label = TRUE,
      label.size = 2,
      repel = TRUE,
      order = TRUE
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = "PCa gene sets from MsigDB") &
      theme(
        plot.title = element_textbox_simple(size = 10, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 8)
      )
    
    plots[[i]] <- p
  }
  
  return(plots)
}

features_all <- names(cod_epith_merged_seurat@meta.data[35:109])
feature_plots <- plot_feature_batches(cod_epith_merged_seurat, features_all, batch_size = 1, ncol = 1)

for (p in feature_plots) {
  print(p)
}

#VlnPlot(cod_epith_merged_seurat, features = names(cod_epith_merged_seurat@meta.data)[35], group.by = "celltype") & theme(plot.title = element_textbox_simple(size = 5), axis.text=element_text(size=5)) & NoLegend()
#VlnPlot(cod_epith_merged_seurat, features = names(cod_epith_merged_seurat@meta.data)[35:37], group.by ="celltype", stack = TRUE, flip = TRUE) & theme(plot.title = element_textbox_simple(size = 2)) & NoLegend()

```

We can inspect the expression of the afformentioned genes in means of sample source to see if we have more expression in tumor samples

```{r, msigDB-genes-in-samples-source-1, warning= FALSE, message= FALSE, echo = FALSE}
FeaturePlot(
      cod_epith_merged_seurat,
      features = names(cod_epith_merged_seurat@meta.data)[34+17],
      ncol = 1,
      label = TRUE,
      label.size = 2,
      repel = TRUE,
      order = TRUE,
      split.by = "sample_source"
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = names(cod_epith_merged_seurat@meta.data)[34+17]) &
      theme(
        plot.title = element_textbox_simple(size = 5, hjust = 0.5),
        plot.subtitle = element_textbox_simple(size = 5, hjust = 0.5)
      ) & NoLegend()
```

```{r, msigDB-genes-in-samples-source-2}
FeaturePlot(
      cod_epith_merged_seurat,
      features = names(cod_epith_merged_seurat@meta.data)[34+48],
      ncol = 1,
      label = TRUE,
      label.size = 2,
      repel = TRUE,
      order = TRUE,
      split.by = "sample_source"
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = names(cod_epith_merged_seurat@meta.data)[34+48]) &
      theme(
        plot.title = element_textbox_simple(size = 5, hjust = 0.5),
        plot.subtitle = element_textbox_simple(size = 5, hjust = 0.5)
      ) & NoLegend()
```

```{r, msigDB-genes-in-samples-source-3}
FeaturePlot(
      cod_epith_merged_seurat,
      features = names(cod_epith_merged_seurat@meta.data)[34+41],
      ncol = 1,
      label = TRUE,
      label.size = 2,
      repel = TRUE,
      order = TRUE,
      split.by = "sample_source"
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = names(cod_epith_merged_seurat@meta.data)[34+41]) &
      theme(
        plot.title = element_textbox_simple(size = 5, hjust = 0.5),
        plot.subtitle = element_textbox_simple(size = 5, hjust = 0.5)
      ) & NoLegend()
```

```{r, msigDB-genes-in-samples-source-4}
FeaturePlot(
      cod_epith_merged_seurat,
      features = names(cod_epith_merged_seurat@meta.data)[34+52],
      ncol = 1,
      label = TRUE,
      label.size = 2,
      repel = TRUE,
      order = TRUE,
      split.by = "sample_source"
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = names(cod_epith_merged_seurat@meta.data)[34+52]) &
      theme(
        plot.title = element_textbox_simple(size = 5, hjust = 0.5),
        plot.subtitle = element_textbox_simple(size = 5, hjust = 0.5)
      ) & NoLegend()
```

```{r, msigDB-genes-in-samples-source-5}
FeaturePlot(
      cod_epith_merged_seurat,
      features = names(cod_epith_merged_seurat@meta.data)[34+27],
      ncol = 1,
      label = TRUE,
      label.size = 2,
      repel = TRUE,
      order = TRUE,
      split.by = "sample_source"
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = names(cod_epith_merged_seurat@meta.data)[34+27]) &
      theme(
        plot.title = element_textbox_simple(size = 5, hjust = 0.5),
        plot.subtitle = element_textbox_simple(size = 5, hjust = 0.5)
      ) & NoLegend()
```

We can see that there are some sub-populations that can be characterized as tumor cells and normal. There are also some sub-populations that show AR activity or are enriched in TMPRSS2-ERG fusions. We are going to proceed in further clustering in LE cells to distinguish these sub-populations. We'll use a resolution of 1.2 for clustering.

```{r, LE-clustering, warning= FALSE, message= FALSE, echo = FALSE}

le_cod_epith_merged_seurat <- subset(x = cod_epith_merged_seurat, subset = manual_annotation == "LE")

le_cod_epith_merged_seurat[["RNA"]] <- split(le_cod_epith_merged_seurat[["RNA"]], f = le_cod_epith_merged_seurat$sample_source)
DefaultAssay(le_cod_epith_merged_seurat) <- "RNA"
le_cod_epith_merged_seurat <- NormalizeData(le_cod_epith_merged_seurat)
le_cod_epith_merged_seurat <- FindVariableFeatures(le_cod_epith_merged_seurat)
le_cod_epith_merged_seurat <- ScaleData(le_cod_epith_merged_seurat)
le_cod_epith_merged_seurat <- RunPCA(le_cod_epith_merged_seurat)
ElbowPlot(le_cod_epith_merged_seurat, ndims = 30)
le_cod_epith_merged_seurat <- IntegrateLayers(
  object = le_cod_epith_merged_seurat, method = CCAIntegration,
  orig.reduction = "pca", new.reduction = "integrated.cca",
  verbose = FALSE, assay = "RNA"
)

le_cod_epith_merged_seurat <- FindNeighbors(le_cod_epith_merged_seurat, reduction = "integrated.cca", dims = 1:30)
le_cod_epith_merged_seurat <- FindClusters(le_cod_epith_merged_seurat, resolution = c(0.3,0.5,0.6,0.7,0.8,0.9,1.0,1.1,1.2,1.3,1.4,1.5,2))

clustree(le_cod_epith_merged_seurat)

le_cod_epith_merged_seurat <- FindClusters(le_cod_epith_merged_seurat, resolution = 1.2, cluster.name = "cca_clusters")
le_cod_epith_merged_seurat <- RunUMAP(le_cod_epith_merged_seurat, reduction = "integrated.cca", dims = 1:30, reduction.name = "umap.cca", return.model = TRUE)

DimPlot(
  le_cod_epith_merged_seurat,
  reduction = "umap.cca",
  group.by = c("sample_source"),
  label.size = 2
  )

DimPlot(
  le_cod_epith_merged_seurat,
  reduction = "umap.cca",
  group.by = c("cca_clusters"),
  label = TRUE
  ) & NoLegend()
```

```{r, module-score-MsigDB-LE, warning= FALSE, message= FALSE, echo = FALSE}
#C2 gene sets from MsigDB

le_cod_epith_merged_seurat <- AddModuleScore(le_cod_epith_merged_seurat,
                  features = c2_PCa_gene_list,
                  name = names(as.list(c2_PCa_gene_list))
                  )
plot_feature_batches <- function(seurat_obj, features, batch_size = 3, ncol = 1) {
  batches <- split(features, ceiling(seq_along(features) / batch_size))
  plots <- list()
  
  for (i in seq_along(batches)) {
    p <- FeaturePlot(
      seurat_obj,
      features = batches[[i]],
      ncol = ncol,
      label = TRUE,
      label.size = 2,
      repel = TRUE,
      order = TRUE
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = "PCa gene sets from MsigDB") &
      theme(
        plot.title = element_textbox_simple(size = 10, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 8)
      )
    
    plots[[i]] <- p
  }
  
  return(plots)
}

features_all <- names(le_cod_epith_merged_seurat@meta.data[c(34+17, 34+48, 34+41, 34+52, 34+27)])
feature_plots <- plot_feature_batches(le_cod_epith_merged_seurat, features_all, batch_size = 1, ncol = 1)

for (p in feature_plots) {
  print(p)
}
```

```{r, featurePlot-by-source, warning= FALSE, message= FALSE, echo = FALSE}

plot_feature_batches_source <- function(seurat_obj, features, batch_size = 3, ncol = 1) {
  batches <- split(features, ceiling(seq_along(features) / batch_size))
  plots <- list()
  
  for (i in seq_along(batches)) {
    p <- FeaturePlot(
      seurat_obj,
      features = batches[[i]],
      reduction = "umap.cca",
      ncol = ncol,
      label = TRUE,
      label.size = 2,
      repel = TRUE,
      order = TRUE,
      split.by = "sample_source"
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = batches[[i]]) &
      theme(
        plot.title = element_textbox_simple(size = 5, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 5)
      ) & NoLegend()
    
    plots[[i]] <- p
  }
  
  return(plots)
}

features_all <- names(le_cod_epith_merged_seurat@meta.data[c(34+17, 34+48, 34+41, 34+52, 34+27)])
feature_plots_source <- plot_feature_batches_source(le_cod_epith_merged_seurat, features_all, batch_size = 1, ncol = 2)

for (p in feature_plots_source) {
  print(p)
}
```

```{r, featurePlot-one-by-one-1, warning= FALSE, message= FALSE, echo = FALSE}
#unique(le_cod_epith_merged_seurat@meta.data$sample_source)
library(scales)
#my_cols <- hue_pal()(19)
#scales::show_col(my_cols)

#names(my_cols) <- levels(le_cod_epith_merged_seurat)
#my_cols2 <- my_cols[order(as.integer(names(my_cols)))]
#scales::show_col(my_cols2)
#my_cols == my_cols2

p1 <- FeaturePlot(
      subset(x = le_cod_epith_merged_seurat, subset = sample_source == "Radical Prostatectomy Paired Tumor" ),
      features = names(le_cod_epith_merged_seurat@meta.data)[34+17],
      ncol = 1,
      label = TRUE,
      label.size = 3,
      #repel = TRUE,
      order = TRUE,
      #split.by = "sample_source"
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = "Radical Prostatectomy Paired Tumor") &
      theme(
        plot.title = element_textbox_simple(size = 5, hjust = 0.5),
        plot.subtitle = element_textbox_simple(size = 5, hjust = 0.5)
      ) & NoLegend() 

p2 <- FeaturePlot(
      subset(x = le_cod_epith_merged_seurat, subset = sample_source == "Radical Prostatectomy Paired Normal"),
      features = names(le_cod_epith_merged_seurat@meta.data)[34+17],
      ncol = 1,
      label = TRUE,
      label.size = 3,
      #repel = TRUE,
      order = TRUE,
      #split.by = "sample_source"
    ) &
      scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) &
      labs(subtitle = "Radical Prostatectomy Paired Normal") &
      theme(
        plot.title = element_textbox_simple(size = 5, hjust = 0.5),
        plot.subtitle = element_textbox_simple(size = 5, hjust = 0.5)
      ) & NoLegend() 
p1 | p2
```

```{r, warning= FALSE, message= FALSE, echo = FALSE}
VlnPlot(le_cod_epith_merged_seurat, features = names(le_cod_epith_merged_seurat@meta.data[c(34+17, 34+48, 34+41, 34+52, 34+27)]), group.by = "cca_clusters", flip = TRUE, stack = TRUE, split.by = "sample_source") & theme(text = element_text(size = 0), axis.title.x = element_blank(), axis.title.y = element_blank()) #& NoLegend()
  #theme(plot.title = element_textbox_simple(size = 0), axis.text=element_text(size=0)) & NoLegend()

```

```{r, VlnPlot-upsVSdown, warning= FALSE, message= FALSE, echo = FALSE}
le_cod_epith_merged_seurat$upVSdown <- le_cod_epith_merged_seurat$`Genes up-regulated in prostate cancer samples.17` - le_cod_epith_merged_seurat$`Genes down-regulated in prostate cancer samples.16`
le_cod_epith_merged_seurat$upVSdown5studies <- le_cod_epith_merged_seurat$`Genes up-regulated in prostate cancer vs benign prostate tissue, based on a meta-analysis of five gene expression profiling studies.48` - le_cod_epith_merged_seurat$`Genes down-regulated in prostate cancer vs benign prostate tissue, based on a meta-analysis of five gene expression profiling studies.47`
VlnPlot(le_cod_epith_merged_seurat, features = "upVSdown", split.by = "sample_source")
VlnPlot(le_cod_epith_merged_seurat, features = "upVSdown5studies", split.by = "sample_source")
```

```{r, RidgePlot-upsVSdown, warning= FALSE, message= FALSE, echo = FALSE}
RidgePlot(le_cod_epith_merged_seurat,features = 'upVSdown',group.by = 'cca_clusters')+NoLegend()
RidgePlot(le_cod_epith_merged_seurat,features = 'upVSdown5studies',group.by = 'cca_clusters')+NoLegend()
```

```{r, LE-PCa-annotation-article, warning= FALSE, message= FALSE, echo = FALSE}
cell_type_PCa_genesets <- read_xlsx("annotations_Song_2022.xlsx", sheet = "PCa signature")
metadata_prior_annotation <- names(le_cod_epith_merged_seurat@meta.data)
#paper annotations
le_cod_epith_merged_seurat <- AddModuleScore(le_cod_epith_merged_seurat,
                  features = as.list(cell_type_PCa_genesets),
                  name = names(as.list(cell_type_PCa_genesets))
  )
features_all <- names(le_cod_epith_merged_seurat@meta.data[c(24,25,30,125:131)])
for(x in features_all){
p <- FeaturePlot(le_cod_epith_merged_seurat, ncol = 1,
            features = x, label = TRUE, repel = TRUE, order =TRUE) &
            scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu" ))) & labs(subtitle = "PCa Signature") &  theme(plot.subtitle = element_text(hjust = 0.5, size = 12) )

print(p)
}

```